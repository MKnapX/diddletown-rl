<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DiddleTown RL ¬∑ 2v2 Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow+Condensed:wght@400;600;700&family=Barlow:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#080a0f;--surface:#0e1117;--surface2:#141820;--border:#1e2535;
    --accent:#00d4ff;--accent2:#ff4d6d;--gold:#ffd700;
    --text:#e8ecf4;--muted:#5a6480;--green:#4ade80;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:'Barlow',sans-serif;min-height:100vh;overflow-x:hidden;}
  body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 60% at 20% 20%,rgba(0,212,255,.04) 0%,transparent 70%),radial-gradient(ellipse 60% 80% at 80% 80%,rgba(255,77,109,.04) 0%,transparent 70%);pointer-events:none;z-index:0;}
  body::after{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(255,255,255,.015) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.015) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}
  .container{max-width:1100px;margin:0 auto;padding:0 24px;position:relative;z-index:1;}
  header{padding:48px 0 32px;text-align:center;}
  .logo-eyebrow{font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:600;letter-spacing:4px;text-transform:uppercase;color:var(--accent);margin-bottom:12px;}
  h1{font-family:'Bebas Neue',sans-serif;font-size:clamp(64px,12vw,120px);line-height:.9;letter-spacing:2px;background:linear-gradient(135deg,#fff 30%,var(--accent) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  .subtitle{font-family:'Barlow Condensed',sans-serif;font-size:18px;letter-spacing:6px;text-transform:uppercase;color:var(--muted);margin-top:8px;}

  /* Loading screen */
  #loading{position:fixed;inset:0;background:var(--bg);z-index:999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;transition:opacity .4s;}
  #loading.hidden{opacity:0;pointer-events:none;}
  .spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg);}}
  .loading-text{font-family:'Barlow Condensed',sans-serif;font-size:13px;letter-spacing:4px;text-transform:uppercase;color:var(--muted);}

  .nav-tabs{display:flex;gap:4px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:4px;margin-bottom:32px;}
  .nav-tab{flex:1;padding:10px 16px;background:none;border:none;color:var(--muted);font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:600;letter-spacing:2px;text-transform:uppercase;cursor:pointer;border-radius:7px;transition:all .2s;}
  .nav-tab.active{background:var(--accent);color:#000;}
  .nav-tab:hover:not(.active){color:var(--text);background:var(--border);}

  .view{display:none;}.view.active{display:block;}
  .section-title{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:3px;color:var(--muted);margin-bottom:16px;display:flex;align-items:center;gap:12px;}
  .section-title::after{content:'';flex:1;height:1px;background:var(--border);}

  /* LEADERBOARD */
  .leaderboard{display:grid;gap:12px;}
  .player-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px 24px;display:grid;grid-template-columns:48px 1fr auto auto auto auto;align-items:center;gap:16px;transition:border-color .2s,transform .2s;position:relative;overflow:hidden;}
  .player-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;border-radius:3px 0 0 3px;background:var(--pc);}
  .player-card:hover{border-color:rgba(255,255,255,.12);transform:translateX(2px);}
  .rank{font-family:'Bebas Neue',sans-serif;font-size:32px;color:var(--muted);text-align:center;line-height:1;}
  .rank.t1{color:var(--gold);}.rank.t2{color:#c0c0c0;}.rank.t3{color:#cd7f32;}
  .p-name{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:700;letter-spacing:1px;}
  .stat-box{text-align:center;}
  .stat-val{font-family:'Bebas Neue',sans-serif;font-size:26px;line-height:1;}
  .stat-lbl{font-family:'Barlow Condensed',sans-serif;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-top:2px;}
  .common-badge{background:var(--accent2);color:#fff;font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:3px 8px;border-radius:4px;}

  /* SESSIONS */
  .session-list{display:grid;gap:16px;}
  .session-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;}
  .session-header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:var(--surface2);border-bottom:1px solid var(--border);flex-wrap:wrap;gap:8px;}
  .session-date{font-family:'Barlow Condensed',sans-serif;font-size:13px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);}
  .s-common{display:flex;align-items:center;gap:8px;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:600;letter-spacing:2px;text-transform:uppercase;}
  .c-dot{width:8px;height:8px;border-radius:50%;}
  .session-matches{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--border);}
  .match-block{background:var(--surface);padding:16px 20px;}
  .match-label{font-family:'Barlow Condensed',sans-serif;font-size:11px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:12px;}
  .team-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;}
  .team-players{display:flex;gap:8px;flex-wrap:wrap;}
  .pchip{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:600;padding:2px 8px;border-radius:4px;background:var(--surface2);border:1px solid var(--border);}
  .score-disp{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:2px;line-height:1;}
  .team-row.winner{background:rgba(74,222,128,.04);border-radius:6px;padding:6px 8px;margin:0 -8px;}
  .session-notes{padding:12px 20px;background:rgba(255,255,255,.02);border-top:1px solid var(--border);font-size:13px;color:var(--muted);font-style:italic;}
  .session-notes a{color:var(--accent);}

  /* DUELS */
  .duel-header{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:28px 32px;display:flex;justify-content:space-around;align-items:center;margin-bottom:24px;}
  .duel-side{text-align:center;}
  .duel-name{font-family:'Bebas Neue',sans-serif;font-size:42px;letter-spacing:2px;line-height:1;}
  .duel-wins{font-family:'Barlow Condensed',sans-serif;font-size:48px;font-weight:700;line-height:1;margin-top:4px;}
  .duel-label{font-family:'Barlow Condensed',sans-serif;font-size:11px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);}
  .duel-vs{font-family:'Bebas Neue',sans-serif;font-size:28px;color:var(--muted);}
  .split-bar{height:12px;border-radius:6px;display:flex;overflow:hidden;margin-bottom:6px;}
  .duel-game{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 16px;display:flex;align-items:center;gap:16px;font-family:'Barlow Condensed',sans-serif;margin-bottom:8px;}
  .duel-game-date{font-size:12px;letter-spacing:2px;color:var(--muted);min-width:90px;}
  .duel-score{font-size:20px;font-weight:700;display:flex;align-items:center;gap:8px;}
  .duel-winner-chip{font-size:12px;font-weight:600;letter-spacing:2px;text-transform:uppercase;padding:2px 8px;border-radius:4px;}

  /* BUTTONS */
  .delete-btn{background:rgba(255,77,109,.15);border:1px solid rgba(255,77,109,.3);color:var(--accent2);font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:600;letter-spacing:2px;text-transform:uppercase;padding:4px 10px;border-radius:5px;cursor:pointer;transition:all .2s;white-space:nowrap;}
  .delete-btn:hover{background:rgba(255,77,109,.3);}

  /* MODAL */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(6px);z-index:100;display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;pointer-events:none;transition:opacity .25s;}
  .modal-overlay.open{opacity:1;pointer-events:all;}
  .modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:32px;width:100%;max-width:620px;max-height:90vh;overflow-y:auto;transform:translateY(20px);transition:transform .25s;}
  .modal-overlay.open .modal{transform:translateY(0);}
  .modal h2{font-family:'Bebas Neue',sans-serif;font-size:32px;letter-spacing:2px;color:var(--accent);margin-bottom:24px;}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;}
  .form-group{display:flex;flex-direction:column;gap:6px;}
  .form-group.full{grid-column:1/-1;}
  label{font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:600;letter-spacing:3px;text-transform:uppercase;color:var(--muted);}
  select,input[type=text],input[type=date],input[type=number],textarea{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);font-family:'Barlow',sans-serif;font-size:14px;outline:none;transition:border-color .2s;width:100%;}
  select:focus,input:focus,textarea:focus{border-color:var(--accent);}
  textarea{resize:vertical;min-height:60px;}
  .form-section{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:16px;}
  .form-section-title{font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--accent);margin-bottom:12px;}
  .score-inputs{display:flex;align-items:center;gap:12px;}
  .score-inputs span{font-family:'Bebas Neue',sans-serif;font-size:24px;color:var(--muted);}
  .score-inputs input{width:64px;text-align:center;font-family:'Bebas Neue',sans-serif;font-size:24px;}
  .btn{padding:12px 24px;border:none;border-radius:8px;font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:700;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all .2s;}
  .btn-primary{background:var(--accent);color:#000;}
  .btn-primary:hover{background:#33ddff;}
  .btn-primary:disabled{background:var(--muted);cursor:not-allowed;}
  .btn-secondary{background:var(--surface2);border:1px solid var(--border);color:var(--text);}
  .btn-secondary:hover{border-color:var(--text);}
  .modal-footer{display:flex;gap:12px;justify-content:flex-end;margin-top:24px;}

  /* FAB */
  .add-fab{position:fixed;bottom:32px;right:32px;width:56px;height:56px;background:var(--accent);border:none;border-radius:50%;font-size:26px;cursor:pointer;z-index:50;box-shadow:0 4px 20px rgba(0,212,255,.4);transition:all .2s;display:flex;align-items:center;justify-content:center;color:#000;font-weight:bold;}
  .add-fab:hover{transform:scale(1.1);box-shadow:0 6px 28px rgba(0,212,255,.6);}
  .fab-menu{position:fixed;bottom:100px;right:32px;display:flex;flex-direction:column;gap:10px;z-index:50;opacity:0;pointer-events:none;transition:all .25s;transform:translateY(10px);}
  .fab-menu.open{opacity:1;pointer-events:all;transform:translateY(0);}
  .fab-item{display:flex;align-items:center;gap:12px;justify-content:flex-end;}
  .fab-label{background:var(--surface);border:1px solid var(--border);padding:6px 14px;border-radius:8px;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--text);white-space:nowrap;}
  .fab-btn{width:44px;height:44px;border-radius:50%;border:none;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;}
  .fab-btn:hover{transform:scale(1.1);}

  /* TOAST */
  .toast{position:fixed;bottom:32px;left:50%;transform:translateX(-50%) translateY(80px);color:#000;font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:12px 24px;border-radius:8px;z-index:200;transition:transform .3s;pointer-events:none;}
  .toast.show{transform:translateX(-50%) translateY(0);}
  .toast.success{background:var(--green);}
  .toast.error{background:var(--accent2);color:#fff;}

  /* Live indicator */
  .live-dot{display:inline-block;width:7px;height:7px;background:var(--green);border-radius:50%;margin-right:6px;animation:pulse 2s infinite;}
  @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.3;}}

  .empty-state{color:var(--muted);text-align:center;padding:48px;font-family:'Barlow Condensed',sans-serif;letter-spacing:2px;text-transform:uppercase;font-size:14px;}

  @media(max-width:640px){
    .player-card{grid-template-columns:36px 1fr;}.stat-box{display:none;}
    .session-matches{grid-template-columns:1fr;}
    .form-row{grid-template-columns:1fr;}
    .duel-header{padding:20px 16px;}.duel-wins{font-size:36px;}
  }
</style>
</head>
<body>

<!-- Loading screen -->
<div id="loading">
  <div class="spinner"></div>
  <div class="loading-text">Connecting to database‚Ä¶</div>
</div>

<div class="container">
  <header>
    <div class="logo-eyebrow">üöó DiddleTown</div>
    <h1>Rocket League</h1>
    <div class="subtitle">2v2 Season Tracker ¬∑ 2026</div>
  </header>

  <nav class="nav-tabs">
    <button class="nav-tab active" onclick="showView('leaderboard',this)">Standings</button>
    <button class="nav-tab" onclick="showView('sessions',this)">Sessions</button>
    <button class="nav-tab" onclick="showView('duels',this)">1v1 Duels</button>
  </nav>

  <!-- STANDINGS -->
  <div class="view active" id="view-leaderboard">
    <div class="section-title"><span class="live-dot"></span>Overall Standings</div>
    <div class="leaderboard" id="leaderboard"></div>
  </div>

  <!-- SESSIONS -->
  <div class="view" id="view-sessions">
    <div class="section-title"><span class="live-dot"></span>Session Log</div>
    <div class="session-list" id="session-list"></div>
  </div>

  <!-- DUELS -->
  <div class="view" id="view-duels">
    <div class="section-title"><span class="live-dot"></span>Lishein vs Will ¬∑ 1v1</div>
    <div class="duel-header">
      <div class="duel-side">
        <div class="duel-name" style="color:var(--accent)">Lishein</div>
        <div class="duel-wins" style="color:var(--accent)" id="d-wins-l">‚Äî</div>
        <div class="duel-label">BO3 Wins</div>
      </div>
      <div class="duel-vs">VS</div>
      <div class="duel-side">
        <div class="duel-name" style="color:#a855f7">Will</div>
        <div class="duel-wins" style="color:#a855f7" id="d-wins-r">‚Äî</div>
        <div class="duel-label">BO3 Wins</div>
      </div>
    </div>
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px 24px;margin-bottom:24px;">
      <div style="font-family:'Barlow Condensed';font-size:12px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:10px;text-align:center">Win Split</div>
      <div class="split-bar">
        <div id="dbar-l" style="background:var(--accent);width:50%;transition:width 1s cubic-bezier(.22,1,.36,1)"></div>
        <div id="dbar-r" style="background:#a855f7;width:50%;transition:width 1s cubic-bezier(.22,1,.36,1)"></div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:6px;">
        <span id="dbar-l-pct" style="font-family:'Barlow Condensed';font-size:12px;color:var(--accent)">‚Äî</span>
        <span id="dbar-r-pct" style="font-family:'Barlow Condensed';font-size:12px;color:#a855f7">‚Äî</span>
      </div>
    </div>
    <div id="duel-games"></div>
  </div>
</div>

<!-- FAB -->
<div class="fab-menu" id="fab-menu">
  <div class="fab-item">
    <span class="fab-label">Add 2v2 Session</span>
    <button class="fab-btn" style="background:var(--accent);color:#000" onclick="openModal('session')">üèéÔ∏è</button>
  </div>
  <div class="fab-item">
    <span class="fab-label">Add 1v1 Result</span>
    <button class="fab-btn" style="background:#a855f7;color:#fff" onclick="openModal('duel')">‚öîÔ∏è</button>
  </div>
</div>
<button class="add-fab" id="add-fab" onclick="toggleFab()">+</button>

<!-- SESSION MODAL -->
<div class="modal-overlay" id="modal-session">
  <div class="modal">
    <h2>Add 2v2 Session</h2>
    <div class="form-row">
      <div class="form-group full"><label>Date</label><input type="date" id="s-date"></div>
    </div>
    <div class="form-section">
      <div class="form-section-title">‚öΩ BO3 Match 1</div>
      <div class="form-row">
        <div class="form-group"><label>Team 1 ¬∑ P1</label><select id="s-b1-t1-p1"></select></div>
        <div class="form-group"><label>Team 1 ¬∑ P2</label><select id="s-b1-t1-p2"></select></div>
        <div class="form-group"><label>Team 2 ¬∑ P1</label><select id="s-b1-t2-p1"></select></div>
        <div class="form-group"><label>Team 2 ¬∑ P2</label><select id="s-b1-t2-p2"></select></div>
      </div>
      <div style="display:flex;align-items:center;justify-content:center;gap:20px;margin-top:4px">
        <span style="font-family:'Barlow Condensed';font-size:12px;letter-spacing:2px;text-transform:uppercase;color:var(--muted)">T1</span>
        <div class="score-inputs">
          <input type="number" id="s-b1-s1" min="0" max="3" value="2">
          <span>‚Äî</span>
          <input type="number" id="s-b1-s2" min="0" max="3" value="1">
        </div>
        <span style="font-family:'Barlow Condensed';font-size:12px;letter-spacing:2px;text-transform:uppercase;color:var(--muted)">T2</span>
      </div>
    </div>
    <div class="form-section">
      <div class="form-section-title">üöÄ BO3 Match 2</div>
      <div class="form-row">
        <div class="form-group"><label>Team 1 ¬∑ P1</label><select id="s-b2-t1-p1"></select></div>
        <div class="form-group"><label>Team 1 ¬∑ P2</label><select id="s-b2-t1-p2"></select></div>
        <div class="form-group"><label>Team 2 ¬∑ P1</label><select id="s-b2-t2-p1"></select></div>
        <div class="form-group"><label>Team 2 ¬∑ P2</label><select id="s-b2-t2-p2"></select></div>
      </div>
      <div style="display:flex;align-items:center;justify-content:center;gap:20px;margin-top:4px">
        <span style="font-family:'Barlow Condensed';font-size:12px;letter-spacing:2px;text-transform:uppercase;color:var(--muted)">T1</span>
        <div class="score-inputs">
          <input type="number" id="s-b2-s1" min="0" max="3" value="2">
          <span>‚Äî</span>
          <input type="number" id="s-b2-s2" min="0" max="3" value="1">
        </div>
        <span style="font-family:'Barlow Condensed';font-size:12px;letter-spacing:2px;text-transform:uppercase;color:var(--muted)">T2</span>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Session Common üòî</label><select id="s-common"></select></div>
      <div class="form-group"><label>Left Early? (DNF)</label><select id="s-dnf"><option value="N">No</option><option value="Y">Yes</option></select></div>
      <div class="form-group full"><label>Notes (optional)</label><textarea id="s-notes" placeholder="e.g. Absolute Headloss, 2 Long Overtimes..."></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('session')">Cancel</button>
      <button class="btn btn-primary" id="save-session-btn" onclick="saveSession()">Save Session üöÄ</button>
    </div>
  </div>
</div>

<!-- DUEL MODAL -->
<div class="modal-overlay" id="modal-duel">
  <div class="modal">
    <h2>Add 1v1 Result</h2>
    <div class="form-row">
      <div class="form-group full"><label>Date</label><input type="date" id="d-date"></div>
    </div>
    <div class="form-section">
      <div class="form-section-title">Match Score</div>
      <div style="display:flex;align-items:center;justify-content:center;gap:24px;margin-top:8px">
        <span style="font-family:'Bebas Neue';font-size:28px;color:var(--accent)">Lishein</span>
        <div class="score-inputs">
          <input type="number" id="d-l-score" min="0" max="3" value="2">
          <span>‚Äî</span>
          <input type="number" id="d-w-score" min="0" max="3" value="1">
        </div>
        <span style="font-family:'Bebas Neue';font-size:28px;color:#a855f7">Will</span>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('duel')">Cancel</button>
      <button class="btn btn-primary" id="save-duel-btn" onclick="saveDuel()">Save Result ‚öîÔ∏è</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, deleteDoc, doc,
  onSnapshot, query, orderBy, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// ‚îÄ‚îÄ Firebase config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const firebaseConfig = {
  apiKey: "AIzaSyCzcUgSWHjKuEZz1ivOhvjlTe1lDoZioAE",
  authDomain: "diddletown-tracker.firebaseapp.com",
  projectId: "diddletown-tracker",
  storageBucket: "diddletown-tracker.firebasestorage.app",
  messagingSenderId: "560291062517",
  appId: "1:560291062517:web:1e1e37485f993df5a1dbbc"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

// ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PLAYERS = ['Will','Lishein','Matt','Alex','James'];
const PC = { Lishein:'#00d4ff', Matt:'#ff4d6d', Will:'#a855f7', Alex:'#fb923c', James:'#4ade80' };

// ‚îÄ‚îÄ Live state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let sessions = [];
let duels    = [];
let sessionsReady = false;
let duelsReady    = false;

function checkReady() {
  if (sessionsReady && duelsReady) {
    document.getElementById('loading').classList.add('hidden');
  }
}

// ‚îÄ‚îÄ Real-time listeners ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
onSnapshot(query(collection(db,'sessions'), orderBy('date','asc')), snap => {
  sessions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  sessionsReady = true;
  checkReady();
  buildLeaderboard();
  buildSessions();
});

onSnapshot(query(collection(db,'duels'), orderBy('date','asc')), snap => {
  duels = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  duelsReady = true;
  checkReady();
  buildDuels();
});

// ‚îÄ‚îÄ Compute stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function computeStats() {
  const s = {};
  PLAYERS.forEach(p => s[p] = { won:0, lost:0, common:0 });
  sessions.forEach(m => {
    [[m.bo3_1.t1,m.bo3_1.t2,m.bo3_1.score],[m.bo3_2.t1,m.bo3_2.t2,m.bo3_2.score]].forEach(([t1,t2,sc]) => {
      t1.forEach(p => { if(s[p]){ s[p].won+=+sc[0]; s[p].lost+=+sc[1]; }});
      t2.forEach(p => { if(s[p]){ s[p].won+=+sc[1]; s[p].lost+=+sc[0]; }});
    });
    if (m.common && s[m.common]) s[m.common].common++;
  });
  return s;
}

// ‚îÄ‚îÄ Leaderboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildLeaderboard() {
  const stats  = computeStats();
  const sorted = Object.entries(stats).sort((a,b) => (b[1].won-b[1].lost) - (a[1].won-a[1].lost));
  const lb = document.getElementById('leaderboard');
  lb.innerHTML = '';
  sorted.forEach(([p,s],i) => {
    const diff = s.won - s.lost;
    const rc   = i===0?'t1':i===1?'t2':i===2?'t3':'';
    const rl   = i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':(i+1);
    const col  = PC[p]||'#aaa';
    lb.innerHTML += `
      <div class="player-card" style="--pc:${col}">
        <div class="rank ${rc}">${rl}</div>
        <div>
          <div class="p-name" style="color:${col}">${p}</div>
          <div style="font-size:12px;color:var(--muted);margin-top:2px;font-family:'Barlow Condensed';letter-spacing:1px">${s.won+s.lost} games played</div>
        </div>
        <div class="stat-box"><div class="stat-val" style="color:#4ade80">${s.won}</div><div class="stat-lbl">Won</div></div>
        <div class="stat-box"><div class="stat-val" style="color:var(--muted)">${s.lost}</div><div class="stat-lbl">Lost</div></div>
        <div class="stat-box"><div class="stat-val" style="color:${diff>0?'#4ade80':diff<0?'var(--accent2)':'var(--text)'}">${diff>0?'+':''}${diff}</div><div class="stat-lbl">Diff</div></div>
        <div class="stat-box">
          ${s.common>0?`<span class="common-badge">üòî ${s.common}x</span>`:`<span style="color:var(--muted);font-size:13px;font-family:'Barlow Condensed'">‚Äî</span>`}
          <div class="stat-lbl">Common</div>
        </div>
      </div>`;
  });
}

// ‚îÄ‚îÄ Sessions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function chip(p) { const c=PC[p]||'#aaa'; return `<span class="pchip" style="border-color:${c}44;color:${c}">${p}</span>`; }
function mblock(bo, lbl) {
  const [s1,s2] = bo.score; const w1 = +s1 > +s2;
  return `<div class="match-block">
    <div class="match-label">${lbl}</div>
    <div class="team-row ${w1?'winner':''}">
      <div class="team-players">${bo.t1.map(chip).join('')}</div>
      <div class="score-disp" style="color:${w1?'#4ade80':'var(--muted)'}">${s1}</div>
    </div>
    <div class="team-row ${!w1?'winner':''}">
      <div class="team-players">${bo.t2.map(chip).join('')}</div>
      <div class="score-disp" style="color:${!w1?'#4ade80':'var(--muted)'}">${s2}</div>
    </div>
  </div>`;
}
function buildSessions() {
  const list = document.getElementById('session-list');
  list.innerHTML = '';
  if (!sessions.length) { list.innerHTML='<div class="empty-state">No sessions yet ‚Äî tap + to add one!</div>'; return; }
  [...sessions].reverse().forEach(m => {
    const date = new Date(m.date+'T12:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'});
    const col  = PC[m.common]||'var(--muted)';
    const nt   = m.notes ? m.notes.trim().replace(/(https?:\/\/[^\s]+)/g, u=>`<a href="${u}" target="_blank">${u}</a>`) : null;
    list.innerHTML += `
      <div class="session-card">
        <div class="session-header">
          <div class="session-date">${date}</div>
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
            <div class="s-common"><div class="c-dot" style="background:${col}"></div><span style="color:${col}">${m.common}</span><span style="color:var(--muted)">is common</span></div>
            <button class="delete-btn" onclick="window._deleteSession('${m.id}')">‚úï Delete</button>
          </div>
        </div>
        <div class="session-matches">
          ${mblock(m.bo3_1,'BO3 ¬∑ Match 1')}
          ${mblock(m.bo3_2,'BO3 ¬∑ Match 2')}
        </div>
        ${nt?`<div class="session-notes">üí¨ ${nt}</div>`:''}
      </div>`;
  });
}

// ‚îÄ‚îÄ Duels ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildDuels() {
  let lw=0, ww=0;
  duels.forEach(d => { if(+d.l>+d.w) lw++; else ww++; });
  const tot = lw+ww||1;
  document.getElementById('d-wins-l').textContent = lw;
  document.getElementById('d-wins-r').textContent = ww;
  document.getElementById('dbar-l').style.width   = (lw/tot*100).toFixed(1)+'%';
  document.getElementById('dbar-r').style.width   = (ww/tot*100).toFixed(1)+'%';
  document.getElementById('dbar-l-pct').textContent = (lw/tot*100).toFixed(1)+'%';
  document.getElementById('dbar-r-pct').textContent = (ww/tot*100).toFixed(1)+'%';
  const ctr = document.getElementById('duel-games');
  ctr.innerHTML = '';
  if (!duels.length) { ctr.innerHTML='<div class="empty-state">No 1v1 results yet!</div>'; return; }
  [...duels].reverse().forEach(d => {
    const isL = +d.l > +d.w;
    const win = isL ? 'Lishein' : 'Will';
    const wc  = isL ? 'var(--accent)' : '#a855f7';
    const dt  = new Date(d.date+'T12:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short'});
    ctr.innerHTML += `
      <div class="duel-game">
        <div class="duel-game-date">${dt}</div>
        <div class="duel-score">
          <span style="color:var(--accent)">${d.l}</span>
          <span style="color:var(--muted);font-size:14px">‚Äî</span>
          <span style="color:#a855f7">${d.w}</span>
        </div>
        <div class="duel-winner-chip" style="background:${wc}22;color:${wc};border:1px solid ${wc}44">${win} wins</div>
        <button class="delete-btn" style="margin-left:auto" onclick="window._deleteDuel('${d.id}')">‚úï</button>
      </div>`;
  });
}

// ‚îÄ‚îÄ CRUD (exposed to window for inline onclick) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window._deleteSession = async (id) => {
  if (!confirm('Delete this session?')) return;
  try {
    await deleteDoc(doc(db,'sessions',id));
    toast('Session deleted','success');
  } catch(e) { toast('Error deleting session','error'); }
};

window._deleteDuel = async (id) => {
  if (!confirm('Delete this result?')) return;
  try {
    await deleteDoc(doc(db,'duels',id));
    toast('Result deleted','success');
  } catch(e) { toast('Error deleting result','error'); }
};

window.saveSession = async () => {
  const d = document.getElementById('s-date').value;
  if (!d) { alert('Please enter a date'); return; }
  const g = id => document.getElementById(id).value;
  const n = id => +document.getElementById(id).value;
  const btn = document.getElementById('save-session-btn');
  btn.disabled = true; btn.textContent = 'Saving‚Ä¶';
  try {
    await addDoc(collection(db,'sessions'), {
      date: d,
      bo3_1: { t1:[g('s-b1-t1-p1'),g('s-b1-t1-p2')], t2:[g('s-b1-t2-p1'),g('s-b1-t2-p2')], score:[n('s-b1-s1'),n('s-b1-s2')] },
      bo3_2: { t1:[g('s-b2-t1-p1'),g('s-b2-t1-p2')], t2:[g('s-b2-t2-p1'),g('s-b2-t2-p2')], score:[n('s-b2-s1'),n('s-b2-s2')] },
      common: g('s-common'),
      dnf: g('s-dnf'),
      notes: document.getElementById('s-notes').value.trim() || null,
      createdAt: serverTimestamp()
    });
    closeModal('session');
    toast('Session saved! üöÄ','success');
  } catch(e) {
    toast('Error saving ‚Äî check Firestore rules','error');
    console.error(e);
  }
  btn.disabled = false; btn.textContent = 'Save Session üöÄ';
};

window.saveDuel = async () => {
  const d = document.getElementById('d-date').value;
  if (!d) { alert('Please enter a date'); return; }
  const btn = document.getElementById('save-duel-btn');
  btn.disabled = true; btn.textContent = 'Saving‚Ä¶';
  try {
    await addDoc(collection(db,'duels'), {
      date: d,
      l: +document.getElementById('d-l-score').value,
      w: +document.getElementById('d-w-score').value,
      createdAt: serverTimestamp()
    });
    closeModal('duel');
    toast('Result saved! ‚öîÔ∏è','success');
  } catch(e) {
    toast('Error saving ‚Äî check Firestore rules','error');
    console.error(e);
  }
  btn.disabled = false; btn.textContent = 'Save Result ‚öîÔ∏è';
};

// ‚îÄ‚îÄ UI helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.showView = (id, btn) => {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('view-'+id).classList.add('active');
  btn.classList.add('active');
};

let fabOpen = false;
window.toggleFab = () => {
  fabOpen = !fabOpen;
  document.getElementById('fab-menu').classList.toggle('open', fabOpen);
  const fab = document.getElementById('add-fab');
  fab.textContent = fabOpen ? '√ó' : '+';
  fab.style.background = fabOpen ? 'var(--accent2)' : 'var(--accent)';
};

function populateSelects() {
  const ids  = ['s-b1-t1-p1','s-b1-t1-p2','s-b1-t2-p1','s-b1-t2-p2','s-b2-t1-p1','s-b2-t1-p2','s-b2-t2-p1','s-b2-t2-p2','s-common'];
  const defs = ['Lishein','Matt','Will','Alex','Lishein','Alex','Will','Matt','Will'];
  ids.forEach((id,i) => {
    const sel = document.getElementById(id);
    sel.innerHTML = PLAYERS.map(p=>`<option value="${p}"${p===defs[i]?' selected':''}>${p}</option>`).join('');
  });
}

window.openModal = (type) => {
  if (type==='session') { document.getElementById('s-date').valueAsDate=new Date(); populateSelects(); }
  else { document.getElementById('d-date').valueAsDate=new Date(); }
  document.getElementById('modal-'+type).classList.add('open');
  if (fabOpen) toggleFab();
};
window.closeModal = (type) => { document.getElementById('modal-'+type).classList.remove('open'); };

document.querySelectorAll('.modal-overlay').forEach(o =>
  o.addEventListener('click', e => { if(e.target===o) o.classList.remove('open'); })
);

let toastTimer;
function toast(msg, type='success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
}
</script>
</body>
</html>
